<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat Export Scanner</title>
    <style>
        :root {
            --whatsapp-green: #128C7E;
            --whatsapp-light-green: #25D366;
            --whatsapp-bg: #E5DDD5;
            --whatsapp-chat-bg: #DCF8C6;
            --whatsapp-received: #FFFFFF;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: var(--whatsapp-green);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .upload-section {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .file-upload {
            display: inline-block;
            margin: 15px 0;
        }
        
        .file-upload-label {
            display: block;
            padding: 12px 24px;
            background-color: var(--whatsapp-green);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-upload-label:hover {
            background-color: var(--whatsapp-light-green);
        }
        
        .file-upload-input {
            display: none;
        }
        
        .control-panel {
            display: flex;
            justify-content: space-between;
            padding: 10px 30px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-buttons button {
            padding: 10px 15px;
            margin-right: 5px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-buttons button.active {
            color: var(--whatsapp-green);
            border-bottom-color: var(--whatsapp-green);
        }
        
        .search-bar {
            display: flex;
            align-items: center;
        }
        
        .search-bar input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .content-section {
            display: flex;
            height: 600px;
        }
        
        .chat-section {
            flex: 1;
            background-color: var(--whatsapp-bg);
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        
        .analytics-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        
        .active-section {
            display: block;
        }
        
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .chat-sent {
            background-color: var(--whatsapp-chat-bg);
            margin-left: auto;
            border-top-right-radius: 0;
        }
        
        .chat-received {
            background-color: var(--whatsapp-received);
            margin-right: auto;
            border-top-left-radius: 0;
        }
        
        .message-info {
            font-size: 0.7rem;
            color: #555;
            text-align: right;
            margin-top: 5px;
        }
        
        .sender-name {
            font-weight: bold;
            color: #303030;
            margin-bottom: 3px;
        }
        
        .analytics-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .analytics-card h3 {
            color: var(--whatsapp-green);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--whatsapp-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .progress-container {
            width: 80%;
            max-width: 300px;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 20px;
            border-radius: 5px;
            background-color: var(--whatsapp-green);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 5px;
            font-size: 14px;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .word-cloud-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }

        .chart-container {
            width: 100%;
            height: 250px;
            margin-top: 20px;
        }

        .date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-divider span {
            background-color: #e1f3fb;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #555;
        }

        .info-message {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Phone View Styles */
        .phone-container {
            max-width: 360px;
            height: 600px;
            margin: 0 auto;
            border: 12px solid #000;
            border-radius: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .phone-container.fullscreen {
            max-width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
        }
        
        .phone-header {
            background-color: #075E54;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
            position: relative;
        }
        
        .phone-header-title {
            margin-left: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .phone-back {
            color: white;
            font-size: 20px;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .phone-fullscreen-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .phone-fullscreen-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .phone-avatar {
            width: 40px;
            height: 40px;
            background-color: #ccc;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .phone-chat-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #E5DDD5;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAQAAACROWYpAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfiARMQDwRaCt24AAAAgUlEQVQ4y+2UMQ6AIAxFX4g3cgAn138m5gLGhHAJB2Ui6FTaDoal/l1S8tL+lhTUUoiJKOFNmFTAa/yAx//+KCUH7vQJRVN917rLsoJZCSjPzxqw1dRQWi1LXXHmyhsrfrA+zIYP9oFOhbdz4YNF4KaHc/WzBVw5gvobn7sXwVuM4n12UK4AAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMTlUMTY6MTU6MDQrMDE6MDDPCDhkAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTE5VDE2OjE1OjA0KzAxOjAwvlWA2AAAAABJRU5ErkJggg==');
            padding: 10px;
        }
        
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .fullscreen-overlay.active {
            display: flex;
        }
        
        .phone-input-area {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0;
            align-items: center;
            flex-shrink: 0;
            border-top: 1px solid #ddd;
        }
        
        .phone-input-box {
            flex-grow: 1;
            background-color: white;
            border-radius: 20px;
            padding: 8px 15px;
            margin: 0 10px;
            border: none;
            height: 40px;
        }
        
        .phone-send-button {
            width: 40px;
            height: 40px;
            background-color: #128C7E;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .phone-chat-bubble {
            max-width: 80%;
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 7px;
            position: relative;
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .phone-sent {
            background-color: #DCF8C6;
            margin-left: auto;
            border-top-right-radius: 0;
        }
        
        .phone-received {
            background-color: white;
            margin-right: auto;
            border-top-left-radius: 0;
        }
        
        .phone-sender-name {
            font-weight: bold;
            color: #303030;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .phone-message-info {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 2px;
        }
        
        .phone-date-divider {
            text-align: center;
            margin: 10px 0;
            position: relative;
        }
        
        .phone-date-divider span {
            background-color: #e1f3fb;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            color: #555;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .content-section {
                flex-direction: column;
                height: auto;
            }
            
            .chat-section, .analytics-section, .phone-section {
                height: 500px;
            }
            
            .chat-bubble {
                max-width: 90%;
            }
            
            .phone-container {
                height: 500px;
            }
        }
        
        .virtual-list {
            height: 100%;
            overflow-y: auto;
            position: relative;
        }
        
        .virtual-content {
            position: absolute;
            width: 100%;
        }
        
        /* Pagination for chat display */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .pagination button {
            padding: 5px 10px;
            margin: 0 5px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .pagination button.active {
            background-color: var(--whatsapp-green);
            color: white;
            border-color: var(--whatsapp-green);
        }
        
        .pagination button:disabled {
            background-color: #f9f9f9;
            color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WhatsApp Chat Export Scanner</h1>
            <p>Lade deinen exportierten WhatsApp-Chat hoch und entdecke interessante Analysen</p>
        </header>
        
        <div class="upload-section">
            <p>Exportiere deinen WhatsApp-Chat (ohne Medien) und lade die Textdatei hier hoch:</p>
            <div class="file-upload">
                <label for="chat-file" class="file-upload-label">
                    <span>Chat-Datei auswählen</span>
                </label>
                <input type="file" id="chat-file" class="file-upload-input" accept=".txt, .zip">
            </div>
            <p class="file-info"></p>
        </div>
        
        <div class="control-panel">
            <div class="tab-buttons">
                <button class="tab-btn active" data-target="chat">Chat anzeigen</button>
                <button class="tab-btn" data-target="analytics">Analysen</button>
                <button class="tab-btn" data-target="phone">WA Handy</button>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Suche im Chat..." id="search-input">
            </div>
        </div>
        
        <div class="content-section">
            <div class="chat-section active-section" id="chat-section">
                <div class="info-message">Bitte lade eine WhatsApp-Chat-Datei hoch, um den Chatverlauf anzuzeigen.</div>
                <div class="pagination" id="chat-pagination" style="display: none;"></div>
            </div>
            
            <div class="analytics-section" id="analytics-section">
                <div class="info-message">Bitte lade eine WhatsApp-Chat-Datei hoch, um Analysen anzuzeigen.</div>
            </div>
            
            <div class="phone-section" id="phone-section" style="display: none;">
                <div class="info-message">Bitte lade eine WhatsApp-Chat-Datei hoch, um den Chat in der Handy-Ansicht zu sehen.</div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-message">Verarbeite Chat-Daten...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">0%</div>
    </div>
    
    <div class="fullscreen-overlay" id="fullscreen-overlay">
        <!-- Phone container will be moved here when in fullscreen mode -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // Global variables
        let chatMessages = [];
        let filteredMessages = [];
        let participants = new Set();
        let charts = {};
        let currentPage = 1;
        let messagesPerPage = 50;
        let totalPages = 1;
        
        // Web Worker to handle parsing
        let worker = null;
        
        // DOM elements
        const fileInput = document.getElementById('chat-file');
        const fileInfo = document.querySelector('.file-info');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const chatSection = document.getElementById('chat-section');
        const analyticsSection = document.getElementById('analytics-section');
        const phoneSection = document.getElementById('phone-section');
        const searchInput = document.getElementById('search-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingMessage = document.getElementById('loading-message');
        const chatPagination = document.getElementById('chat-pagination');

        // Initialize Web Worker
        function initWorker() {
            const workerCode = `
                // Web Worker for parsing WhatsApp chat
                self.onmessage = function(e) {
                    const { action, data } = e.data;
                    
                    if (action === 'parse') {
                        parseWhatsAppChat(data);
                    }
                };
                
                // Parse WhatsApp chat export
                function parseWhatsAppChat(content) {
                    // Reset data
                    const chatMessages = [];
                    const participants = new Set();
                    
                    // Split by new lines
                    const lines = content.split('\\n');
                    const totalLines = lines.length;
                    
                    // Pattern to match WhatsApp messages
                    // [DD.MM.YY, HH:mm:ss] Name: Message
                    const messagePattern = /^\\[(\\d{2}\\.\\d{2}\\.\\d{2}),\\s(\\d{1,2}:\\d{2}(?::\\d{2})?)\\](?:\\s(.+?):\\s(.+)|(.+))/;
                    
                    let currentDate = '';
                    let messageBuffer = '';
                    let currentMessage = null;
                    
                    // Process in chunks to report progress
                    const chunkSize = 1000;
                    let processedLines = 0;
                    
                    function processChunk(startIdx) {
                        const endIdx = Math.min(startIdx + chunkSize, totalLines);
                        
                        for (let i = startIdx; i < endIdx; i++) {
                            const line = lines[i];
                            const match = messagePattern.exec(line);
                            
                            if (match) {
                                // If we have a message in the buffer, save it
                                if (currentMessage) {
                                    currentMessage.text = messageBuffer.trim();
                                    chatMessages.push(currentMessage);
                                    messageBuffer = '';
                                }
                                
                                // Extract date, time, sender and message
                                const date = match[1];
                                const time = match[2];
                                const sender = match[3] || 'System';
                                const messageText = match[4] || match[5] || '';
                                
                                // Format date for comparison
                                if (date !== currentDate) {
                                    currentDate = date;
                                }
                                
                                // Create new message object
                                currentMessage = {
                                    date: date,
                                    time: time,
                                    sender: sender,
                                    text: messageText,
                                    datetime: parseDateTime(date, time)
                                };
                                
                                // Add sender to participants set (excluding system messages)
                                if (sender !== 'System') {
                                    participants.add(sender);
                                }
                                
                                // Start buffer with current message
                                messageBuffer = messageText;
                            } else {
                                // If no match, it's a continuation of the previous message
                                messageBuffer += '\\n' + line;
                            }
                        }
                        
                        processedLines = endIdx;
                        const progress = Math.round((processedLines / totalLines) * 100);
                        
                        // Report progress
                        self.postMessage({
                            action: 'progress',
                            progress: progress
                        });
                        
                        if (processedLines < totalLines) {
                            // Process next chunk
                            setTimeout(() => processChunk(processedLines), 0);
                        } else {
                            // Finished all chunks
                            if (currentMessage) {
                                currentMessage.text = messageBuffer.trim();
                                chatMessages.push(currentMessage);
                            }
                            
                            // Send the results back
                            self.postMessage({
                                action: 'complete',
                                messages: chatMessages,
                                participants: Array.from(participants)
                            });
                        }
                    }
                    
                    // Start processing
                    processChunk(0);
                }
                
                // Parse date and time to Date object
                function parseDateTime(dateStr, timeStr) {
                    // Format: DD.MM.YY, HH:mm:ss
                    const parts = dateStr.split('.');
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // months are 0-indexed
                    const year = 2000 + parseInt(parts[2], 10); // assuming 20xx
                    
                    const timeParts = timeStr.split(':');
                    const hour = parseInt(timeParts[0], 10);
                    const minute = parseInt(timeParts[1], 10);
                    const second = timeParts.length > 2 ? parseInt(timeParts[2], 10) : 0;
                    
                    return new Date(year, month, day, hour, minute, second).getTime();
                }
            `;
            
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            worker = new Worker(URL.createObjectURL(blob));
            
            worker.onmessage = function(e) {
                const { action, progress, messages, participants: participantsArray } = e.data;
                
                if (action === 'progress') {
                    updateProgress(progress);
                } else if (action === 'complete') {
                    chatMessages = messages;
                    participants = new Set(participantsArray);
                    
                    // Update UI once parsing is complete
                    finishProcessing();
                }
            };
        }
        
        // Initialize app
        function init() {
            initWorker();
            
            // Event listeners
            fileInput.addEventListener('change', handleFileUpload);
            tabButtons.forEach(btn => {
                btn.addEventListener('click', switchTab);
            });
            searchInput.addEventListener('input', _.debounce(searchChat, 300));
        }
        
        // Switch between tabs
        function switchTab(e) {
            // Remove active class from all buttons
            tabButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            e.target.classList.add('active');
            
            // Hide all sections
            chatSection.classList.remove('active-section');
            analyticsSection.classList.remove('active-section');
            const phoneSection = document.getElementById('phone-section');
            phoneSection.style.display = 'none';
            
            // Show selected section
            const targetSection = e.target.getAttribute('data-target');
            if (targetSection === 'chat') {
                chatSection.classList.add('active-section');
            } else if (targetSection === 'analytics') {
                analyticsSection.classList.add('active-section');
            } else if (targetSection === 'phone') {
                phoneSection.style.display = 'block';
                // Render phone view if not already rendered
                if (chatMessages.length > 0 && phoneSection.querySelector('.phone-container') === null) {
                    renderPhoneView();
                }
            }
        }
        
        // Handle file upload
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            fileInfo.textContent = `Ausgewählte Datei: ${file.name}`;
            loadingOverlay.style.display = 'flex';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            loadingMessage.textContent = 'Verarbeite Datei...';
            
            try {
                let content;
                
                // Check if it's a zip file
                if (file.name.endsWith('.zip')) {
                    loadingMessage.textContent = 'Entpacke ZIP-Datei...';
                    content = await extractChatFromZip(file);
                } else {
                    // Read as text file
                    content = await readFileAsText(file);
                }
                
                if (!content) {
                    throw new Error('Keine Chat-Datei gefunden');
                }
                
                loadingMessage.textContent = 'Analysiere Chat-Daten...';
                
                // Process in Web Worker
                worker.postMessage({
                    action: 'parse',
                    data: content
                });
            } catch (error) {
                console.error('Error processing file:', error);
                loadingOverlay.style.display = 'none';
                fileInfo.textContent = `Fehler: ${error.message}`;
            }
        }
        
        // Extract chat from zip file
        async function extractChatFromZip(file) {
            const jszip = new JSZip();
            const zip = await jszip.loadAsync(file);
            
            // Look for .txt files in the zip
            let chatFile = null;
            
            // First try to find _chat.txt
            if (zip.file('_chat.txt')) {
                chatFile = zip.file('_chat.txt');
            } else {
                // Otherwise look for any .txt file
                const txtFiles = Object.keys(zip.files).filter(name => name.endsWith('.txt'));
                if (txtFiles.length > 0) {
                    chatFile = zip.file(txtFiles[0]);
                }
            }
            
            if (chatFile) {
                return await chatFile.async('string');
            } else {
                throw new Error('Keine Chat-Datei in der ZIP gefunden');
            }
        }
        
        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Datei konnte nicht gelesen werden'));
                reader.readAsText(file);
            });
        }
        
        // Update progress bar
        function updateProgress(progress) {
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
        }
        
        // Finish processing
        function finishProcessing() {
            // Set filtered messages to all messages initially
            filteredMessages = [...chatMessages];
            
            // Calculate total pages
            totalPages = Math.ceil(filteredMessages.length / messagesPerPage);
            currentPage = 1;
            
            // Render chat with pagination
            renderPagination();
            renderChatPage(currentPage);
            
            // Prepare basic analytics
            preAnalyzeChat(chatMessages);
            
            // Update phone view if it's active
            const phoneTab = document.querySelector('.tab-btn[data-target="phone"]');
            if (phoneTab.classList.contains('active')) {
                renderPhoneView();
            }
            
            loadingOverlay.style.display = 'none';
            chatPagination.style.display = 'block';
        }
        
        // Render phone view
        function renderPhoneView() {
            phoneSection.innerHTML = '';
            
            if (chatMessages.length === 0) {
                phoneSection.innerHTML = '<div class="info-message">Keine Chat-Nachrichten gefunden.</div>';
                return;
            }
            
            // Create phone container
            const phoneContainer = document.createElement('div');
            phoneContainer.className = 'phone-container';
            phoneContainer.id = 'phone-container';
            
            // Create phone header
            const phoneHeader = document.createElement('div');
            phoneHeader.className = 'phone-header';
            
            // Get chat participants
            const participantsArray = Array.from(participants);
            const chatName = participantsArray.length > 1 ? 
                            participantsArray.slice(0, 2).join(', ') + (participantsArray.length > 2 ? '...' : '') : 
                            participantsArray[0];
            
            phoneHeader.innerHTML = `
                <div class="phone-back">←</div>
                <div class="phone-avatar">${chatName.charAt(0)}</div>
                <div class="phone-header-title">${chatName}</div>
                <div class="phone-fullscreen-toggle" id="fullscreen-btn">⛶</div>
            `;
            
            // Create chat container
            const phoneChatContainer = document.createElement('div');
            phoneChatContainer.className = 'phone-chat-container';
            
            // Create input area
            const phoneInputArea = document.createElement('div');
            phoneInputArea.className = 'phone-input-area';
            phoneInputArea.innerHTML = `
                <div class="phone-emoji">😊</div>
                <div class="phone-input-box">Nachricht</div>
                <div class="phone-send-button">→</div>
            `;
            
            // Add elements to phone container
            phoneContainer.appendChild(phoneHeader);
            phoneContainer.appendChild(phoneChatContainer);
            phoneContainer.appendChild(phoneInputArea);
            
            // Add phone container to phone section
            phoneSection.appendChild(phoneContainer);
            
            // Add fullscreen toggle function
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            
            // Render messages in batches to avoid freezing
            renderPhoneMessages(phoneChatContainer, chatMessages);
        }
        
        // Toggle fullscreen mode for phone view
        function toggleFullscreen() {
            const fullscreenOverlay = document.getElementById('fullscreen-overlay');
            const phoneContainer = document.getElementById('phone-container');
            
            if (fullscreenOverlay.classList.contains('active')) {
                // Exit fullscreen mode
                fullscreenOverlay.classList.remove('active');
                phoneSection.appendChild(phoneContainer);
                document.getElementById('fullscreen-btn').textContent = '⛶';
                
                // If browser is in fullscreen mode, exit that too
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.error('Error exiting fullscreen:', err);
                    });
                }
            } else {
                // Enter fullscreen mode
                fullscreenOverlay.classList.add('active');
                fullscreenOverlay.appendChild(phoneContainer);
                document.getElementById('fullscreen-btn').textContent = '❌';
                
                // Request browser fullscreen if supported
                if (fullscreenOverlay.requestFullscreen) {
                    fullscreenOverlay.requestFullscreen().catch(err => {
                        console.error('Error entering fullscreen:', err);
                    });
                }
            }
        }
        
        // Render phone messages in batches
        function renderPhoneMessages(container, messages) {
            // Show loading message
            container.innerHTML = '<div class="info-message">Lade Nachrichten...</div>';
            
            // Process in batches to avoid freezing
            const batchSize = 200; // Adjust batch size based on performance
            const totalBatches = Math.ceil(messages.length / batchSize);
            
            loadingMessage.textContent = 'Lade Handy-Ansicht...';
            loadingOverlay.style.display = 'flex';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            
            // Clear container
            container.innerHTML = '';
            
            // Process batches
            function processBatch(batchIndex) {
                const startIdx = batchIndex * batchSize;
                const endIdx = Math.min(startIdx + batchSize, messages.length);
                
                // Create document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                let currentDate = '';
                
                for (let i = startIdx; i < endIdx; i++) {
                    const message = messages[i];
                    
                    // Add date divider if it's a new date
                    if (message.date !== currentDate) {
                        currentDate = message.date;
                        const dateDivider = document.createElement('div');
                        dateDivider.className = 'phone-date-divider';
                        dateDivider.innerHTML = `<span>${formatDate(currentDate)}</span>`;
                        fragment.appendChild(dateDivider);
                    }
                    
                    // Create message bubble
                    const bubble = document.createElement('div');
                    bubble.className = 'phone-chat-bubble';
                    
                    // Determine if it's from "me" (last participant in the list)
                    const participantsArray = Array.from(participants);
                    const isFromMe = message.sender === participantsArray[participantsArray.length - 1];
                    bubble.classList.add(isFromMe ? 'phone-sent' : 'phone-received');
                    
                    // Add sender name if it's not from me and not in a one-on-one chat
                    if (!isFromMe && message.sender !== 'System' && participantsArray.length > 2) {
                        const senderElement = document.createElement('div');
                        senderElement.className = 'phone-sender-name';
                        senderElement.textContent = message.sender;
                        bubble.appendChild(senderElement);
                    }
                    
                    // Add message text
                    const messageText = document.createElement('div');
                    messageText.className = 'phone-message-text';
                    messageText.textContent = message.text;
                    bubble.appendChild(messageText);
                    
                    // Add message info (time)
                    const messageInfo = document.createElement('div');
                    messageInfo.className = 'phone-message-info';
                    messageInfo.textContent = message.time;
                    bubble.appendChild(messageInfo);
                    
                    fragment.appendChild(bubble);
                }
                
                container.appendChild(fragment);
                
                // Update progress
                const progress = Math.round(((batchIndex + 1) / totalBatches) * 100);
                updateProgress(progress);
                
                if (batchIndex + 1 < totalBatches) {
                    // Process next batch after a small delay
                    setTimeout(() => processBatch(batchIndex + 1), 10);
                } else {
                    // All done, hide loading overlay
                    loadingOverlay.style.display = 'none';
                    
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            // Start processing batches
            setTimeout(() => processBatch(0), 50);
        }
        
        // Format date for display
        function formatDate(dateStr) {
            const parts = dateStr.split('.');
            const day = parts[0];
            const month = parts[1];
            const year = '20' + parts[2];
            
            // Create a date object to get day name
            const date = new Date(year, month - 1, day);
            const dayName = date.toLocaleDateString('de-DE', { weekday: 'long' });
            
            return `${dayName}, ${day}.${month}.${year}`;
        }
        
        // Render pagination
        function renderPagination() {
            chatPagination.innerHTML = '';
            
            if (totalPages <= 1) {
                chatPagination.style.display = 'none';
                return;
            }
            
            chatPagination.style.display = 'flex';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = '«';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => goToPage(currentPage - 1);
            chatPagination.appendChild(prevButton);
            
            // Page buttons
            const maxButtons = 5;
            const start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            const end = Math.min(totalPages, start + maxButtons - 1);
            
            for (let i = start; i <= end; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.onclick = () => goToPage(i);
                chatPagination.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = '»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => goToPage(currentPage + 1);
            chatPagination.appendChild(nextButton);
        }
        
        // Go to page
        function goToPage(pageNum) {
            if (pageNum < 1 || pageNum > totalPages) return;
            
            currentPage = pageNum;
            renderPagination();
            renderChatPage(currentPage);
        }
        
        // Render chat page
        function renderChatPage(page) {
            chatSection.innerHTML = '';
            
            if (filteredMessages.length === 0) {
                chatSection.innerHTML = '<div class="info-message">Keine Chat-Nachrichten gefunden.</div>';
                chatPagination.style.display = 'none';
                return;
            }
            
            // Calculate start and end indices for current page
            const startIndex = (page - 1) * messagesPerPage;
            const endIndex = Math.min(startIndex + messagesPerPage, filteredMessages.length);
            
            // Get messages for current page
            const pageMessages = filteredMessages.slice(startIndex, endIndex);
            
            let currentDate = '';
            
            pageMessages.forEach(message => {
                // Add date divider if it's a new date
                if (message.date !== currentDate) {
                    currentDate = message.date;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    dateDivider.innerHTML = `<span>${formatDate(currentDate)}</span>`;
                    chatSection.appendChild(dateDivider);
                }
                
                // Create message bubble
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                
                // Determine if it's from "me" (last participant in the list)
                const participantsArray = Array.from(participants);
                const isFromMe = message.sender === participantsArray[participantsArray.length - 1];
                bubble.classList.add(isFromMe ? 'chat-sent' : 'chat-received');
                
                // Add sender name if it's not from me
                if (!isFromMe && message.sender !== 'System') {
                    const senderElement = document.createElement('div');
                    senderElement.className = 'sender-name';
                    senderElement.textContent = message.sender;
                    bubble.appendChild(senderElement);
                }
                
                // Add message text
                const messageText = document.createElement('div');
                messageText.className = 'message-text';
                messageText.textContent = message.text;
                bubble.appendChild(messageText);
                
                // Add message info (time)
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                messageInfo.textContent = message.time;
                bubble.appendChild(messageInfo);
                
                chatSection.appendChild(bubble);
            });
            
            // Add pagination after the messages
            chatSection.appendChild(chatPagination);
        }
        
        // Search chat messages
        function searchChat() {
            const searchTerm = searchInput.value.toLowerCase();
            
            if (!searchTerm) {
                filteredMessages = [...chatMessages];
            } else {
                filteredMessages = chatMessages.filter(message => 
                    message.text.toLowerCase().includes(searchTerm) || 
                    message.sender.toLowerCase().includes(searchTerm)
                );
            }
            
            // Recalculate pagination
            totalPages = Math.ceil(filteredMessages.length / messagesPerPage);
            currentPage = 1;
            
            // Update UI
            renderPagination();
            renderChatPage(currentPage);
        }
        
        // Preanalyze chat data - compute basic statistics only
        function preAnalyzeChat(messages) {
            if (messages.length === 0) {
                analyticsSection.innerHTML = '<div class="info-message">Keine Chat-Nachrichten für Analysen gefunden.</div>';
                return;
            }
            
            // Prepare analytics section with placeholder
            analyticsSection.innerHTML = `
                <div class="analytics-card">
                    <h3>Allgemeine Statistiken</h3>
                    <div class="stat-row">
                        <span>Gesamtzahl Nachrichten:</span>
                        <span>${messages.length.toLocaleString()}</span>
                    </div>
                    <div class="stat-row">
                        <span>Anzahl Teilnehmer:</span>
                        <span>${participants.size}</span>
                    </div>
                    <div class="stat-row">
                        <span>Erster Chat-Tag:</span>
                        <span>${formatDate(messages[0].date)}</span>
                    </div>
                    <div class="stat-row">
                        <span>Letzter Chat-Tag:</span>
                        <span>${formatDate(messages[messages.length - 1].date)}</span>
                    </div>
                </div>
                <div id="analytics-placeholder" class="info-message">
                    <p>Klicke auf "Detaillierte Analyse starten", um weitere Analysen zu generieren.</p>
                    <button id="start-analysis-btn" class="file-upload-label" style="display: inline-block; margin-top: 15px;">Detaillierte Analyse starten</button>
                </div>
            `;
            
            // Add event listener for analysis button
            document.getElementById('start-analysis-btn').addEventListener('click', () => analyzeChat(messages));
        }
        
        // Analyze chat data - uses worker for heavy processing
        function analyzeChat(messages) {
            // Remove placeholder
            const placeholder = document.getElementById('analytics-placeholder');
            if (placeholder) placeholder.remove();
            
            loadingMessage.textContent = 'Erstelle Analysen...';
            loadingOverlay.style.display = 'flex';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            
            // Define analytics state object
            const analyticsState = {
                totalMessages: messages.length,
                participantsArray: Array.from(participants),
                messageCountBySender: {},
                messageCountByDate: {},
                wordFrequency: {},
                messagesByHour: Array(24).fill(0),
                messagesByDay: Array(7).fill(0),
                stopWords: ['der', 'die', 'das', 'und', 'ist', 'in', 'zu', 'den', 'mit', 'auf', 'für', 'von', 'im', 'nicht', 'ein', 'eine', 'es', 'ich', 'du', 'wir', 'ihr', 'sie', 'er', 'dass', 'sich', 'auch', 'als', 'so', 'zum', 'wie', 'bei', 'nach', 'um', 'an', 'aus', 'aber', 'noch', 'nur']
            };
            
            // Process analysis in sequential steps to avoid freezing
            processAnalysisStep(0, messages, analyticsState);
        }
        
        // Process analysis in steps to avoid freezing the browser
        function processAnalysisStep(step, messages, state) {
            try {
                switch(step) {
                    case 0: // Message count by sender
                        updateProgress(10);
                        loadingMessage.textContent = 'Analysiere Nachrichten pro Person...';
                        
                        // Use a more efficient approach
                        messages.forEach(message => {
                            if (!state.messageCountBySender[message.sender]) {
                                state.messageCountBySender[message.sender] = 0;
                            }
                            state.messageCountBySender[message.sender]++;
                        });
                        
                        setTimeout(() => processAnalysisStep(1, messages, state), 10);
                        break;
                        
                    case 1: // Message count by date
                        updateProgress(20);
                        loadingMessage.textContent = 'Analysiere Aktivität über Zeit...';
                        
                        messages.forEach(message => {
                            if (!state.messageCountByDate[message.date]) {
                                state.messageCountByDate[message.date] = 0;
                            }
                            state.messageCountByDate[message.date]++;
                        });
                        
                        setTimeout(() => processAnalysisStep(2, messages, state), 10);
                        break;
                        
                    case 2: // Process word frequency in chunks
                        updateProgress(30);
                        loadingMessage.textContent = 'Analysiere häufigste Wörter (1/3)...';
                        
                        // Start processing words in chunks
                        processWordChunks(0, 30, messages, state);
                        break;
                        
                    case 3: // Messages by hour and day
                        updateProgress(70);
                        loadingMessage.textContent = 'Analysiere Aktivitätsmuster...';
                        
                        // Process in smaller chunks for large datasets
                        const chunkSize = 10000;
                        const chunks = Math.ceil(messages.length / chunkSize);
                        
                        function processTimeChunk(chunkIndex) {
                            const start = chunkIndex * chunkSize;
                            const end = Math.min(start + chunkSize, messages.length);
                            
                            for (let i = start; i < end; i++) {
                                const message = messages[i];
                                const date = new Date(message.datetime);
                                const hour = date.getHours();
                                const day = date.getDay();
                                
                                state.messagesByHour[hour]++;
                                state.messagesByDay[day]++;
                            }
                            
                            if (chunkIndex + 1 < chunks) {
                                setTimeout(() => processTimeChunk(chunkIndex + 1), 0);
                            } else {
                                setTimeout(() => processAnalysisStep(4, messages, state), 10);
                            }
                        }
                        
                        processTimeChunk(0);
                        break;
                        
                    case 4: // Render everything
                        updateProgress(90);
                        loadingMessage.textContent = 'Erstelle Visualisierungen...';
                        
                        // Sort word frequency
                        const sortedWords = Object.entries(state.wordFrequency)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 50);
                        
                        // Render each component with small delays
                        setTimeout(() => {
                            renderMessageCountBySender(state.messageCountBySender);
                            setTimeout(() => {
                                renderWordFrequency(sortedWords, state.wordFrequency);
                                setTimeout(() => {
                                    renderActivityOverTime(state.messageCountByDate);
                                    setTimeout(() => {
                                        renderMessagesByHour(state.messagesByHour);
                                        setTimeout(() => {
                                            renderMessagesByDay(state.messagesByDay);
                                            
                                            updateProgress(100);
                                            loadingOverlay.style.display = 'none';
                                        }, 100);
                                    }, 100);
                                }, 100);
                            }, 100);
                        }, 100);
                        break;
                }
            } catch (error) {
                console.error('Fehler bei der Analyse:', error);
                loadingOverlay.style.display = 'none';
                
                // Show error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'analytics-card';
                errorMessage.innerHTML = `
                    <h3>Fehler bei der Analyse</h3>
                    <p>Es ist ein Fehler aufgetreten: ${error.message}</p>
                    <p>Versuche es mit einer kleineren Chat-Datei oder kontaktiere den Support.</p>
                `;
                analyticsSection.appendChild(errorMessage);
            }
        }
        
        // Process word frequency in chunks to avoid UI freezes
        function processWordChunks(startPercent, endPercent, messages, state) {
            const chunkSize = 1000;
            const totalChunks = Math.ceil(messages.length / chunkSize);
            let currentChunk = 0;
            
            function processNextChunk() {
                loadingMessage.textContent = `Analysiere häufigste Wörter (${Math.min(currentChunk+1, totalChunks)}/${totalChunks})...`;
                
                const startIdx = currentChunk * chunkSize;
                const endIdx = Math.min(startIdx + chunkSize, messages.length);
                
                // Process this chunk
                for (let i = startIdx; i < endIdx; i++) {
                    // Only process every nth message for very large chats to improve performance
                    if (messages.length > 50000 && i % 3 !== 0) continue;
                    
                    const message = messages[i];
                    const words = message.text.toLowerCase()
                        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
                        .split(/\s+/);
                    
                    // Limit words per message to avoid processing very long messages
                    const maxWordsPerMessage = 100;
                    const wordsToProcess = words.length <= maxWordsPerMessage ? words : words.slice(0, maxWordsPerMessage);
                    
                    wordsToProcess.forEach(word => {
                        if (word.length > 2 && !state.stopWords.includes(word)) {
                            if (!state.wordFrequency[word]) {
                                state.wordFrequency[word] = 0;
                            }
                            state.wordFrequency[word]++;
                        }
                    });
                }
                
                currentChunk++;
                
                // Update progress
                const progress = startPercent + Math.floor((currentChunk / totalChunks) * (endPercent - startPercent));
                updateProgress(progress);
                
                if (currentChunk < totalChunks) {
                    // Process next chunk after a small delay
                    setTimeout(processNextChunk, 0);
                } else {
                    // Move to next analysis step
                    setTimeout(() => processAnalysisStep(3, messages, state), 10);
                }
            }
            
            // Start processing
            processNextChunk();
        }
        
        // Render basic statistics
        function renderBasicStats(totalMessages, participantCount) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            
            // Format first and last date
            const firstDate = formatDate(chatMessages[0].date);
            const lastDate = formatDate(chatMessages[chatMessages.length - 1].date);
            
            card.innerHTML = `
                <h3>Allgemeine Statistiken</h3>
                <div class="stat-row">
                    <span>Gesamtzahl Nachrichten:</span>
                    <span>${totalMessages.toLocaleString()}</span>
                </div>
                <div class="stat-row">
                    <span>Anzahl Teilnehmer:</span>
                    <span>${participantCount}</span>
                </div>
                <div class="stat-row">
                    <span>Erster Chat-Tag:</span>
                    <span>${firstDate}</span>
                </div>
                <div class="stat-row">
                    <span>Letzter Chat-Tag:</span>
                    <span>${lastDate}</span>
                </div>
            `;
            analyticsSection.appendChild(card);
        }
        
        // Render message count by sender
        function renderMessageCountBySender(messageCountBySender) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `<h3>Nachrichten pro Person</h3>`;
            
            const entries = Object.entries(messageCountBySender)
                .sort((a, b) => b[1] - a[1]);
            
            entries.forEach(([sender, count]) => {
                const row = document.createElement('div');
                row.className = 'stat-row';
                row.innerHTML = `
                    <span>${sender}:</span>
                    <span>${count.toLocaleString()} (${Math.round(count / chatMessages.length * 100)}%)</span>
                `;
                card.appendChild(row);
            });
            
            analyticsSection.appendChild(card);
            
            // Create chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '250px';
            card.appendChild(chartContainer);
            
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: entries.map(entry => entry[0]),
                    datasets: [{
                        data: entries.map(entry => entry[1]),
                        backgroundColor: generateColors(entries.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 10,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            charts.senderPie = chart;
        }
        
        // Render word frequency with optimized rendering
        function renderWordFrequency(wordFrequency, fullWordFrequency) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `
                <h3>Häufigste Wörter</h3>
                <div class="top-words-container"></div>
            `;
            
            analyticsSection.appendChild(card);
            
            // Add top 20 list (simpler, faster than word cloud)
            const topWordsContainer = card.querySelector('.top-words-container');
            
            const top20Words = wordFrequency.slice(0, 20);
            top20Words.forEach(([word, count], index) => {
                const row = document.createElement('div');
                row.className = 'stat-row';
                row.innerHTML = `
                    <span>${index + 1}. ${word}</span>
                    <span>${count.toLocaleString()}x</span>
                `;
                topWordsContainer.appendChild(row);
            });
            
            // Add a "Show Word Cloud" button instead of rendering directly
            const wordCloudButton = document.createElement('button');
            wordCloudButton.className = 'file-upload-label';
            wordCloudButton.style.marginTop = '20px';
            wordCloudButton.textContent = 'Word Cloud anzeigen';
            wordCloudButton.addEventListener('click', () => {
                // Replace button with word cloud
                wordCloudButton.remove();
                
                // Add container for word cloud
                const wordCloudContainer = document.createElement('div');
                wordCloudContainer.id = 'word-cloud';
                wordCloudContainer.className = 'word-cloud-container';
                wordCloudContainer.style.height = '250px';
                wordCloudContainer.style.marginTop = '20px';
                card.appendChild(wordCloudContainer);
                
                // Create word cloud with fewer words for better performance
                // Limit to only 50 words for better performance
                const wordCloudData = wordFrequency.slice(0, 50).map(([word, count]) => ({
                    text: word,
                    size: Math.max(10, Math.min(40, count * 2)) // Scale size down for performance
                }));
                
                // Render word cloud in a smaller size for better performance
                const width = Math.min(document.getElementById('word-cloud').offsetWidth, 400);
                const height = 200;
                
                try {
                    const layout = d3.layout.cloud()
                        .size([width, height])
                        .words(wordCloudData)
                        .padding(2)
                        .rotate(() => ~~(Math.random() * 2) * 90)
                        .font('Impact')
                        .fontSize(d => d.size)
                        .on('end', draw);
                        
                    layout.start();
                } catch (error) {
                    console.error('Fehler beim Erstellen der Word Cloud:', error);
                    wordCloudContainer.innerHTML = '<p>Word Cloud konnte nicht erstellt werden.</p>';
                }
                
                function draw(words) {
                    try {
                        d3.select('#word-cloud').append('svg')
                            .attr('width', layout.size()[0])
                            .attr('height', layout.size()[1])
                            .append('g')
                            .attr('transform', `translate(${layout.size()[0] / 2},${layout.size()[1] / 2})`)
                            .selectAll('text')
                            .data(words)
                            .enter().append('text')
                            .style('font-size', d => `${d.size}px`)
                            .style('font-family', 'Impact')
                            .style('fill', (d, i) => d3.schemeCategory10[i % 10])
                            .attr('text-anchor', 'middle')
                            .attr('transform', d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                            .text(d => d.text);
                    } catch (error) {
                        console.error('Fehler beim Zeichnen der Word Cloud:', error);
                        wordCloudContainer.innerHTML = '<p>Word Cloud konnte nicht gezeichnet werden.</p>';
                    }
                }
            });
            
            card.appendChild(wordCloudButton);
        }
        
        // Render activity over time with performance optimization
        function renderActivityOverTime(messageCountByDate) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `<h3>Aktivität über Zeit</h3>`;
            
            analyticsSection.appendChild(card);
            
            try {
                // Get sorted dates
                const dates = Object.keys(messageCountByDate).sort();
                
                // If we have a lot of dates, just show summary stats first
                if (dates.length > 50) {
                    // Create summary stats
                    const summaryContainer = document.createElement('div');
                    
                    // Find peak date
                    let peakDate = dates[0];
                    let peakCount = messageCountByDate[peakDate];
                    
                    dates.forEach(date => {
                        if (messageCountByDate[date] > peakCount) {
                            peakCount = messageCountByDate[date];
                            peakDate = date;
                        }
                    });
                    
                    // Calculate average messages per day
                    const totalMessages = Object.values(messageCountByDate).reduce((sum, count) => sum + count, 0);
                    const avgMessagesPerDay = Math.round(totalMessages / dates.length);
                    
                    // Display summary
                    summaryContainer.innerHTML = `
                        <div class="stat-row">
                            <span>Tage mit Nachrichten:</span>
                            <span>${dates.length}</span>
                        </div>
                        <div class="stat-row">
                            <span>Durchschnittliche Nachrichten pro Tag:</span>
                            <span>${avgMessagesPerDay}</span>
                        </div>
                        <div class="stat-row">
                            <span>Tag mit den meisten Nachrichten:</span>
                            <span>${formatDate(peakDate)} (${peakCount} Nachrichten)</span>
                        </div>
                    `;
                    
                    card.appendChild(summaryContainer);
                    
                    // Add button to show chart
                    const showChartButton = document.createElement('button');
                    showChartButton.className = 'file-upload-label';
                    showChartButton.style.marginTop = '15px';
                    showChartButton.textContent = 'Diagramm anzeigen';
                    showChartButton.addEventListener('click', () => {
                        showChartButton.remove();
                        renderActivityChart(card, dates, messageCountByDate);
                    });
                    
                    card.appendChild(showChartButton);
                } else {
                    // Directly render chart for smaller datasets
                    renderActivityChart(card, dates, messageCountByDate);
                }
            } catch (error) {
                console.error('Fehler beim Erstellen des Aktivitätsdiagramms:', error);
                card.innerHTML += '<p>Aktivitätsdiagramm konnte nicht erstellt werden.</p>';
            }
        }
        
        // Helper function to render activity chart
        function renderActivityChart(container, dates, messageCountByDate) {
            // Create chart container
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '250px';
            container.appendChild(chartContainer);
            
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            
            // Sample data for better performance
            let sampledDates = dates;
            let sampledCounts = [];
            
            if (dates.length > 60) {
                // Group dates by month for better visualization
                const groupedDates = {};
                
                dates.forEach(date => {
                    // Extract month and year
                    const parts = date.split('.');
                    const monthYear = `${parts[1]}.${parts[2]}`;
                    
                    if (!groupedDates[monthYear]) {
                        groupedDates[monthYear] = 0;
                    }
                    
                    groupedDates[monthYear] += messageCountByDate[date];
                });
                
                // Convert back to array
                sampledDates = Object.keys(groupedDates).sort();
                sampledCounts = sampledDates.map(date => groupedDates[date]);
            } else {
                sampledCounts = dates.map(date => messageCountByDate[date]);
            }
            
            try {
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sampledDates.map(date => {
                            // If grouped by month, just return that
                            if (date.split('.').length === 2) {
                                return date;
                            }
                            // Otherwise, format individual dates
                            const parts = date.split('.');
                            return `${parts[0]}.${parts[1]}`;
                        }),
                        datasets: [{
                            label: 'Nachrichten',
                            data: sampledCounts,
                            borderColor: 'rgba(18, 140, 126, 1)',
                            backgroundColor: 'rgba(18, 140, 126, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: sampledDates.length > 30 ? 0 : 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 10,
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        animation: {
                            duration: 500
                        }
                    }
                });
                
                charts.activityLine = chart;
            } catch (error) {
                console.error('Fehler beim Erstellen des Aktivitätsdiagramms:', error);
                container.innerHTML += '<p>Aktivitätsdiagramm konnte nicht erstellt werden.</p>';
            }
        }
        
        // Render messages by hour
        function renderMessagesByHour(messagesByHour) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `<h3>Aktivität nach Stunde</h3>`;
            
            analyticsSection.appendChild(card);
            
            // Create chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '250px';
            card.appendChild(chartContainer);
            
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Nachrichten',
                        data: messagesByHour,
                        backgroundColor: 'rgba(18, 140, 126, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            charts.hourBar = chart;
        }
        
        // Render messages by day of week
        function renderMessagesByDay(messagesByDay) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `<h3>Aktivität nach Wochentag</h3>`;
            
            analyticsSection.appendChild(card);
            
            // Create chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '250px';
            card.appendChild(chartContainer);
            
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            
            const dayLabels = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Nachrichten',
                        data: messagesByDay,
                        backgroundColor: 'rgba(18, 140, 126, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            charts.dayBar = chart;
        }
        
        // Generate colors for charts
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
            }
            return colors;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
